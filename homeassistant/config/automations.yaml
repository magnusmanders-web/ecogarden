# ==============================================
# HOME ASSISTANT AUTOMATIONS
# ==============================================

# ----------------------------------------------
# LIGHTING AUTOMATIONS
# ----------------------------------------------

# Sunset: Turn on outdoor lights
- id: 'sunset_outdoor_lights'
  alias: 'Sunset - Outdoor Lights On'
  description: 'Turn on outdoor lights at sunset'
  trigger:
    - platform: sun
      event: sunset
      offset: '-00:15:00'
  action:
    - service: light.turn_on
      target:
        entity_id:
          - light.garden
          - light.baksidan_ute
          - light.uteplats
          - light.hue_outdoor_pedestal_1
          - light.hue_outdoor_pedestal_2
          - light.hue_outdoor_pedestal_3
      data:
        brightness_pct: 80

# Late night: Turn off all lights
- id: 'late_night_lights_off'
  alias: 'Late Night - All Lights Off'
  description: 'Turn off all lights at 1 AM'
  trigger:
    - platform: time
      at: '01:00:00'
  action:
    - service: light.turn_off
      target:
        entity_id: all

# Motion in library - lights on (daytime dimmed, evening bright)
- id: 'library_motion_lights'
  alias: 'Library - Motion Activated Lights'
  description: 'Turn on library lights when motion detected'
  trigger:
    - platform: state
      entity_id: binary_sensor.library_sensor_motion
      to: 'on'
  condition:
    - condition: state
      entity_id: light.library
      state: 'off'
  action:
    - service: light.turn_on
      target:
        entity_id: light.library
      data:
        brightness_pct: "{{ 40 if is_state('sun.sun', 'above_horizon') else 80 }}"

# Motion in bedroom - gentle light at night
- id: 'bedroom_motion_night'
  alias: 'Bedroom - Night Motion Light'
  description: 'Gentle light when motion at night'
  trigger:
    - platform: state
      entity_id: binary_sensor.sensor_sovrum_motion
      to: 'on'
  condition:
    - condition: time
      after: '22:00:00'
      before: '07:00:00'
  action:
    - service: light.turn_on
      target:
        entity_id: light.bedroom
      data:
        brightness_pct: 10
        color_temp: 500

# Outdoor lights off at sunrise
- id: 'sunrise_outdoor_off'
  alias: 'Sunrise - Outdoor Lights Off'
  description: 'Turn off outdoor lights after sunrise'
  trigger:
    - platform: sun
      event: sunrise
      offset: '00:30:00'
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.garden
          - light.baksidan_ute
          - light.uteplats
          - light.hue_outdoor_pedestal_1
          - light.hue_outdoor_pedestal_2
          - light.hue_outdoor_pedestal_3

# ----------------------------------------------
# ENERGY AUTOMATIONS
# ----------------------------------------------

# High power usage alert
- id: 'high_power_alert'
  alias: 'Energy - High Power Usage Alert'
  description: 'Alert when power exceeds 15kW'
  trigger:
    - platform: numeric_state
      entity_id: sensor.tibber_pulse_fiskarevagen_6_power
      above: 15000
      for:
        minutes: 5
  action:
    - service: persistent_notification.create
      data:
        title: "‚ö° High Power Usage"
        message: "Power consumption is {{ states('sensor.tibber_pulse_fiskarevagen_6_power') }} W"
        notification_id: high_power

# Daily cost exceeded
- id: 'daily_cost_alert'
  alias: 'Energy - Daily Cost Alert'
  description: 'Alert when daily cost exceeds 300 SEK'
  trigger:
    - platform: numeric_state
      entity_id: sensor.tibber_pulse_fiskarevagen_6_accumulated_cost
      above: 300
  action:
    - service: persistent_notification.create
      data:
        title: "üí∞ High Energy Cost"
        message: "Today's electricity cost has reached {{ states('sensor.tibber_pulse_fiskarevagen_6_accumulated_cost') }} SEK"
        notification_id: high_cost

# ----------------------------------------------
# VACUUM AUTOMATIONS
# ----------------------------------------------

# Vacuum on weekdays at 10 AM
- id: 'vacuum_weekday_schedule'
  alias: 'Vacuum - Weekday Schedule'
  description: 'Start vacuum cleaning on weekdays at 10:00'
  trigger:
    - platform: time
      at: '10:00:00'
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
  action:
    - service: vacuum.start
      target:
        entity_id: vacuum.roborock_s7_maxv

# Vacuum finished notification
- id: 'vacuum_done_notification'
  alias: 'Vacuum - Cleaning Complete'
  description: 'Notify when vacuum returns to dock'
  trigger:
    - platform: state
      entity_id: vacuum.roborock_s7_maxv
      to: 'returning'
  action:
    - wait_for_trigger:
        - platform: state
          entity_id: vacuum.roborock_s7_maxv
          to: 'docked'
      timeout: '00:30:00'
    - service: persistent_notification.create
      data:
        title: "ü§ñ Vacuum Complete"
        message: "Roborock has finished cleaning and returned to dock"
        notification_id: vacuum_done

# ----------------------------------------------
# MAINTENANCE AUTOMATIONS
# ----------------------------------------------

# Low battery alert
- id: 'low_battery_alert'
  alias: 'Maintenance - Low Battery Alert'
  description: 'Alert when any sensor battery is below 20%'
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.library_sensor_battery
        - sensor.sensor_sovrum_battery
        - sensor.hue_motion_sensor_1_battery
        - sensor.dimmer_battery
      below: 20
  action:
    - service: persistent_notification.create
      data:
        title: "üîã Low Battery"
        message: "{{ trigger.to_state.attributes.friendly_name }} battery is at {{ trigger.to_state.state }}%"
        notification_id: "low_battery_{{ trigger.entity_id }}"

# ----------------------------------------------
# ECOGARDEN AUTOMATIONS
# ----------------------------------------------

# EcoGarden optimal grow light schedule
# 16h photoperiod (06:00-22:00) with gradual sunrise/sunset ramp
# Optimized for herbs (oregano, basil, lettuce) in 100% artificial light

# --- Sunrise ramp (06:00 - 07:00) ---
- id: 'ecogarden_sunrise_1'
  alias: 'EcoGarden - Sunrise 10%'
  trigger:
    - platform: time
      at: '06:00:00'
  action:
    - service: rest_command.ecogarden_set_brightness
      data:
        brightness: 0.1

- id: 'ecogarden_sunrise_2'
  alias: 'EcoGarden - Sunrise 30%'
  trigger:
    - platform: time
      at: '06:15:00'
  action:
    - service: rest_command.ecogarden_set_brightness
      data:
        brightness: 0.3

- id: 'ecogarden_sunrise_3'
  alias: 'EcoGarden - Sunrise 60%'
  trigger:
    - platform: time
      at: '06:30:00'
  action:
    - service: rest_command.ecogarden_set_brightness
      data:
        brightness: 0.6

- id: 'ecogarden_sunrise_4'
  alias: 'EcoGarden - Full Intensity'
  trigger:
    - platform: time
      at: '07:00:00'
  action:
    - service: rest_command.ecogarden_set_brightness
      data:
        brightness: 1.0

# --- Sunset ramp (20:00 - 22:00) ---
- id: 'ecogarden_sunset_1'
  alias: 'EcoGarden - Sunset 60%'
  trigger:
    - platform: time
      at: '20:30:00'
  action:
    - service: rest_command.ecogarden_set_brightness
      data:
        brightness: 0.6

- id: 'ecogarden_sunset_2'
  alias: 'EcoGarden - Sunset 30%'
  trigger:
    - platform: time
      at: '21:00:00'
  action:
    - service: rest_command.ecogarden_set_brightness
      data:
        brightness: 0.3

- id: 'ecogarden_sunset_3'
  alias: 'EcoGarden - Sunset 10%'
  trigger:
    - platform: time
      at: '21:30:00'
  action:
    - service: rest_command.ecogarden_set_brightness
      data:
        brightness: 0.1

- id: 'ecogarden_sunset_off'
  alias: 'EcoGarden - Grow Light Off'
  trigger:
    - platform: time
      at: '22:00:00'
  action:
    - service: rest_command.ecogarden_set_brightness
      data:
        brightness: 0

# EcoGarden feeding schedule (twice daily)
- id: 'ecogarden_feed_morning'
  alias: 'EcoGarden - Morning Feed'
  description: 'Feed fish in the morning'
  trigger:
    - platform: time
      at: '08:00:00'
  action:
    - service: rest_command.ecogarden_feed

- id: 'ecogarden_feed_evening'
  alias: 'EcoGarden - Evening Feed'
  description: 'Feed fish in the evening'
  trigger:
    - platform: time
      at: '18:00:00'
  action:
    - service: rest_command.ecogarden_feed

# Water temperature alert
- id: 'ecogarden_temp_alert'
  alias: 'EcoGarden - Temperature Alert'
  description: 'Alert if water temperature is out of range'
  trigger:
    - platform: numeric_state
      entity_id: sensor.ecogarden_water_temperature
      above: 28
    - platform: numeric_state
      entity_id: sensor.ecogarden_water_temperature
      below: 18
  action:
    - service: persistent_notification.create
      data:
        title: "üê† EcoGarden Temperature Alert"
        message: "Water temperature is {{ states('sensor.ecogarden_water_temperature') }}¬∞C - check your fish!"
        notification_id: ecogarden_temp

# Low light warning (cloudy day or sensor issue)
- id: 'ecogarden_low_light'
  alias: 'EcoGarden - Low Light Warning'
  description: 'Alert if light level is too low during grow hours'
  trigger:
    - platform: numeric_state
      entity_id: sensor.ecogarden_light_level
      below: 10
      for:
        minutes: 30
  condition:
    - condition: time
      after: '06:30:00'
      before: '21:30:00'
    - condition: state
      entity_id: light.ecogarden_growlight
      state: 'on'
  action:
    - service: persistent_notification.create
      data:
        title: "üå± EcoGarden Low Light"
        message: "Light level is only {{ states('sensor.ecogarden_light_level') }}% - check if growlight is working!"
        notification_id: ecogarden_light
